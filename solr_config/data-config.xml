<dataConfig>
  <dataSource  type="FileDataSource" encoding="US-ASCII" />

  <script> <![CDATA[

    function getNamespaceInfo(row) {

      var domainLookup = {
        biometrics: 'Biometrics',
        cbrn: 'Chemical, Biological, Radiological, Nuclear',
        cyfs: 'Children, Youth & Family Services',
        emergencyManagement: 'Emergency Management',
        humanServices: 'Human Services',
        immigration: 'Immigration',
        infrastructureProtection: 'Infrastructure Protection',
        intelligence: 'Intelligence',
        internationalTrade: 'International Trade',
        jxdm: 'Justice',
        maritime: 'Maritime',
        militaryOperations: 'Military Operations',
        screening: 'Screening',
        surfaceTransportation: 'Surface Transportation'
      };

      var fileName = row.get("file");
      var namespace = fileName.substring(0, fileName.indexOf('.'));

      var path = row.get("fileAbsolutePath");
      var namespaceType;
      var domain;

      // Determine if file is in domains dir
      if (path.indexOf('domains') > -1) {
        namespaceType = 'domain';
        
        // Loop through domainLookup object to find match        
        Object.keys(domainLookup).forEach(function(key) {
          if (path.indexOf(key) > -1) {
            domain = domainLookup[key];
          }
        });

      } else if ( path.indexOf('codes') > -1 || path.indexOf('external' > -1) ) {
        namespaceType = 'external';
      } else {
        namespaceType = 'other';
      }
      
      if (domain) {
        row.put("domain", domain);
      }

      row.put("namespace", namespace);
      row.put("namespaceType", namespaceType);

      return row;

    };


    function getFacetList(row) {

      var columns = row.keySet().toArray();

      var facetsObject = {};

      for (var c = 0; c < columns.length; c++) {
        var columnName = columns[c];

        if (columnName.toLowerCase().contains('facet')) {

          var value = row.get(columnName);

          if (value !== null && value.contains(null) === false) {

            var facetName = columnName.split('_')[1];
            var facetKey = columnName.split('_')[0];

            if (facetName in facetsObject === false) {
              facetsObject[facetName] = {};
            }

            facetsObject[facetName][facetKey] = value.toString();

            row.remove(columnName);
          
          }
        }

      }

      var facetString = JSON.stringify(facetsObject);
      row.put("facets", facetString);

      return row;
    };

  ]]>  
  </script>

  <document>

    <!-- this outer processor generates a list of files satisfying the conditions specified in the attributes -->
    <entity name="f" 
            processor="FileListEntityProcessor"
            fileName=".*xsd"
            recursive="true"
            rootEntity="false"
            dataSource="null"
            excludes="gmx.xsd"
            onError="skip"
            transformer="script:getNamespaceInfo,TemplateTransformer"
            baseDir="/solr-6.2.0/niem-xsd">

      <!-- the inner processors extract content using Xpath from each file found -->
      <entity name="element"
              url="${f.fileAbsolutePath}"
              processor="XPathEntityProcessor"
              stream="true"
              transformer="TemplateTransformer"
              forEach="/schema/element" >

        <field column ="id"               template="${f.namespace}:${element.name}" />
        <field column="name"              xpath="/schema/element/@name"                        boost="5.0" />            
        <field column="entityType"        template="Element" />
        <field column="definition"        xpath="/schema/element/annotation/documentation"     boost="2.0" />
        <field column="type"              xpath="/schema/element/@type" />
        <field column="substitutionGroup" xpath="/schema/element/@substitutionGroup" />
        <field column="abstract"          xpath="/schema/element/@abstract" />
      </entity>


      <entity name="complexType"
              url="${f.fileAbsolutePath}"
              processor="XPathEntityProcessor"
              stream="true"
              transformer="TemplateTransformer"                      
              forEach="/schema/complexType" >

        <field column ="id"               template="${f.namespace}:${complexType.name}" />
        <field column="name"              xpath="/schema/complexType/@name"                        boost="5.0" />            
        <field column="definition"        xpath="/schema/complexType/annotation/documentation"     boost="2.0" />
        <field column="entityType"        template="Type" />

        <!-- For CCC -->
        <field column="parentTypeName"    xpath="/schema/complexType/complexContent/extension/@base" />
        <field column="elements"          xpath="/schema/complexType/complexContent/extension/sequence/element/@ref" />

        <!-- For CSC; todo: confirm this is correct naming -->
        <field column="parentSimpleType"  xpath="/schema/complexType/simpleContent/extension/@base" />      
        <field column="attributeGroup"    xpath="/schema/complexType/simpleContent/extension/attributeGroup/@ref" />      
        <field column="attributes"        xpath="/schema/complexType/simpleContent/extension/attribute/@ref" />            
      </entity>


      <entity name="attribute"
              url="${f.fileAbsolutePath}"
              processor="XPathEntityProcessor"
              stream="true"
              transformer="TemplateTransformer"
              forEach="/schema/attribute" >
        
        <field column="attribute_id"         template="${f.namespace}:${attribute.attribute_name}" />
        <field column="attribute_name"        xpath="/schema/attribute/@name" />            
        <field column="attribute_definition"  xpath="/schema/attribute/annotation/documentation" />
        <field column="attribute_type"        xpath="/schema/attribute/@type" />
      </entity>


      <entity name="attributeGroup"
              url="${f.fileAbsolutePath}"
              processor="XPathEntityProcessor"
              stream="true"
              transformer="TemplateTransformer"                        
              forEach="/schema/attributeGroup" >
        
        <field column="attributeGroup_id"        template="${f.namespace}:${attributeGroup.attributeGroup_name}" />
        <field column="attributeGroup_name"       xpath="/schema/attributeGroup/@name" />         
        <field column="attributeGroup_attributes" xpath="/schema/attributeGroup/attribute/@ref" />
      </entity>


      <entity name="simpleType"
              url="${f.fileAbsolutePath}"
              processor="XPathEntityProcessor"
              stream="true"
              transformer="script:getFacetList,TemplateTransformer"                             
              forEach="/schema/simpleType" >


        <field column ="id"           template="${f.namespace}:${simpleType.name}" />
        <field column="name"          xpath="/schema/simpleType/@name"                        boost="5.0" />            
        <field column="definition"    xpath="/schema/simpleType/annotation/documentation"     boost="2.0" />
        <field column="entityType"    template="Type" />

        <field column="facetValue_enumeration"        xpath="/schema/simpleType/restriction/enumeration/@value" />
        <field column="facetValue_minInclusive"       xpath="/schema/simpleType/restriction/minInclusive/@value" />
        <field column="facetValue_maxInclusive"       xpath="/schema/simpleType/restriction/maxInclusive/@value" />
        <field column="facetValue_minExclusive"       xpath="/schema/simpleType/restriction/minExclusive/@value" />
        <field column="facetValue_maxExclusive"       xpath="/schema/simpleType/restriction/maxExclusive/@value" />
        <field column="facetValue_minLength"          xpath="/schema/simpleType/restriction/minLength/@value" />
        <field column="facetValue_maxLength"          xpath="/schema/simpleType/restriction/maxLength/@value" />
        <field column="facetValue_pattern"            xpath="/schema/simpleType/restriction/pattern/@value" />
        <field column="facetValue_totalDigits"        xpath="/schema/simpleType/restriction/totalDigits/@value" />

        <field column="facetDefinition_enumeration"        xpath="/schema/simpleType/restriction/enumeration/annotation/documentation" />
        <field column="facetDefinition_minInclusive"       xpath="/schema/simpleType/restriction/minInclusive/annotation/documentation" />
        <field column="facetDefinition_maxInclusive"       xpath="/schema/simpleType/restriction/maxInclusive/annotation/documentation" />
        <field column="facetDefinition_minExclusive"       xpath="/schema/simpleType/restriction/minExclusive/annotation/documentation" />
        <field column="facetDefinition_maxExclusive"       xpath="/schema/simpleType/restriction/maxExclusive/annotation/documentation" />
        <field column="facetDefinition_minLength"          xpath="/schema/simpleType/restriction/minLength/annotation/documentation" />
        <field column="facetDefinition_maxLength"          xpath="/schema/simpleType/restriction/maxLength/annotation/documentation" />
        <field column="facetDefinition_pattern"            xpath="/schema/simpleType/restriction/pattern/annotation/documentation" />
        <field column="facetDefinition_totalDigits"        xpath="/schema/simpleType/restriction/totalDigits/annotation/documentation" />

      </entity>

    </entity>

  </document>
</dataConfig>